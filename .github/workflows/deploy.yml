name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS and Reset Docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1
        env:
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: VPS_PROJECT_PATH
          script: |
            # Set project path from environment or use default
            PROJECT_PATH="${VPS_PROJECT_PATH:-$HOME/TenseAI}"

            # Ensure project directory exists
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "Project directory does not exist: $PROJECT_PATH"
              echo "Please ensure the directory exists and contains the repository."
              exit 1
            fi

            # Navigate to project directory
            cd "$PROJECT_PATH" || { echo "Failed to navigate to $PROJECT_PATH"; exit 1; }

            # Make deploy script executable and run it
            if [ ! -f "deploy/deploy.sh" ]; then
              echo "deploy/deploy.sh not found in $PROJECT_PATH"
              exit 1
            fi

            chmod +x deploy/deploy.sh
            bash deploy/deploy.sh
