---
import { AccountForm } from "@/components/account/AccountForm";
import AppLayout from "@/layouts/AppLayout.astro";
import { ProfileRepository } from "@/server/repositories/profile.repository";
import type { ProfileDTO } from "@/types";

// Get authenticated user from locals (set by middleware)
const supabase = Astro.locals.supabase;
const session = Astro.locals.user;

if (!session) {
  return Astro.redirect("/login");
}

// Fetch user profile server-side for initial form data
let profile: ProfileDTO | null = null;
try {
  const profileRepository = new ProfileRepository(supabase);
  profile = await profileRepository.getProfileById(session.id);
} catch {
  // Profile will be null if fetch fails
  // AccountForm will handle null profile with default values
}
---

<AppLayout title="Account - TenseAI">
  <AccountForm initialProfile={profile} client:load />
</AppLayout>
