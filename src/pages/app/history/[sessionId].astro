---
import { HistoryDetailWrapper } from "@/components/history-detail/history-detail-wrapper";
import AppLayout from "@/layouts/app-layout.astro";
import { NavigationRoutes } from "@/lib/enums/navigation";
import { ProfileRepository } from "@/server/repositories/profile.repository";
import { TrainingSessionService } from "@/server/services/training-session.service";
import { authenticateUser } from "@/server/utils/auth";

export const prerender = false;

const { sessionId } = Astro.params;
if (!sessionId) {
  return Astro.redirect(NavigationRoutes.HISTORY, 302);
}

const supabase = Astro.locals.supabase;
let userId: string;
try {
  userId = await authenticateUser(supabase);
} catch {
  return Astro.redirect(NavigationRoutes.LOGIN, 302);
}

const service = new TrainingSessionService(supabase);
let sessionDetail;
try {
  sessionDetail = await service.getSessionDetail(userId, sessionId);
  if (sessionDetail.training_session.status !== "completed") {
    return Astro.redirect(`${NavigationRoutes.TRAINING}/${sessionId}`, 302);
  }
} catch {
  return Astro.redirect(NavigationRoutes.HISTORY, 302);
}

const profile = await new ProfileRepository(supabase).getProfileById(userId);
const userName = profile?.name ?? null;
---

<AppLayout
  title={`History: ${sessionDetail.training_session.tense} - TenseAI`}
  mainClassName="p-0 lg:p-0 lg:px-8 lg:pb-8"
>
  <HistoryDetailWrapper sessionData={sessionDetail} userName={userName} />
</AppLayout>
