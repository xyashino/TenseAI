---
import { HistoryDetailView } from "@/features/history";
import BaseLayout from "@/layouts/base-layout.astro";
import { NavigationRoutes } from "@/lib/enums/navigation";
import { ProfileRepository } from "@/server/modules/profile";
import { TrainingService } from "@/server/modules/training";
import { authenticateUser } from "@/server/utils/auth";

export const prerender = false;

const { sessionId } = Astro.params;
if (!sessionId) {
  return Astro.redirect(NavigationRoutes.HISTORY, 302);
}

const supabase = Astro.locals.supabase;
let userId: string;
try {
  userId = await authenticateUser(supabase);
} catch {
  return Astro.redirect(NavigationRoutes.LOGIN, 302);
}

const service = new TrainingService(supabase);
let sessionDetail;
try {
  sessionDetail = await service.getSessionDetail(userId, sessionId);
  if (sessionDetail.training_session.status !== "completed") {
    return Astro.redirect(`${NavigationRoutes.TRAINING}/${sessionId}`, 302);
  }
} catch {
  return Astro.redirect(NavigationRoutes.HISTORY, 302);
}

const profile = await new ProfileRepository(supabase).getProfileById(userId);
const userName = profile?.name ?? null;
---

<BaseLayout title={`History: ${sessionDetail.training_session.tense} - TenseAI`}>
  <HistoryDetailView client:load sessionData={sessionDetail} userName={userName} />
</BaseLayout>
