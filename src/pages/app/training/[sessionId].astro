---
import { TrainingSessionViewWithQueryClient } from "@/features/training";
import BaseLayout from "@/layouts/base-layout.astro";
import { NavigationRoutes } from "@/lib/enums/navigation";
import { ProfileRepository } from "@/server/modules/profile";
import { TrainingService } from "@/server/modules/training";
import { authenticateUser } from "@/server/utils/auth";
export const prerender = false;

const { sessionId } = Astro.params;
if (!sessionId) {
  return Astro.redirect(NavigationRoutes.TRAINING);
}

const supabase = Astro.locals.supabase;
const userId = await authenticateUser(supabase);

const service = new TrainingService(supabase);
let sessionData;
let roundsData;
let sessionSummary;
try {
  const { training_session, rounds, summary } = await service.getSessionDetail(userId, sessionId);
  if (training_session.status === "completed") {
    return Astro.redirect(NavigationRoutes.TRAINING);
  }
  sessionData = {
    sessionId: training_session.id,
    tense: training_session.tense,
    difficulty: training_session.difficulty,
    status: training_session.status,
    finalFeedback: training_session.final_feedback,
  };
  roundsData = rounds ?? [];
  sessionSummary = summary;
} catch {
  return Astro.redirect(NavigationRoutes.TRAINING);
}

const profile = await new ProfileRepository(supabase).getProfileById(userId);
const userName = profile?.name ?? null;
---

<BaseLayout title={`Training: ${sessionData.tense} - TenseAI`}>
  <TrainingSessionViewWithQueryClient
    client:load
    sessionId={sessionId}
    tense={sessionData.tense}
    difficulty={sessionData.difficulty}
    status={sessionData.status}
    userName={userName}
    rounds={roundsData}
    summary={sessionSummary}
    finalFeedback={sessionData.finalFeedback}
  />
</BaseLayout>
